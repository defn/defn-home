#!/usr/bin/env bash

function main {
  # link cache files
  if [[ -d /vagrant ]]; then
    ln -nfs /vagrant/{distfiles,cache,packages} ~/
  fi

  # make sure we are at home
  set -x
  cd

  # initialize new ssh hosts
  ssh -oStrictHostKeyChecking=no github.com true
  ssh -oStrictHostKeyChecking=no bitbucket.org true
  ssh -oStrictHostKeyChecking=no localhost true

  # clone home
  git clone git@github.com:defn/home home
  mv home/.git .
  git reset --hard
  git clean -fd

  # bootstrap app
  git clone git@github.com:defn/app work/app
  pushd work/app
  set +x; source script/profile; set -x
  app bootstrap
  set +x; require; set -x
  popd

  # bootstrap home
  script/bootstrap
  set +x; require; set -x

  # bootstrap everything
  app bootstrap

  # get docker0 up
  sudo restart docker || sudo start docker
  sleep 5
  cat | sudo tee -a /etc/default/docker <<"__EOF"
DOCKER_OPTS="--dns $(ip route show | awk '$3 == "docker0" { print $NF }') -H tcp://0.0.0.0:"
__EOF

  # ensure bind is listening on docker0
  sudo restart docker
  sleep 5
  sudo aptitude install -y bind9
  sudo service bind9 restart

  # build docker image
  docker pull ubuntu
  docker tag ubuntu:latest ubuntu:packer-input
  basebox build docker

  # configure routing
  echo 1 | sudo tee /proc/sys/net/ipv4/ip_forward  
  echo "net.ipv4.ip_forward=1" | sudo tee /etc/sysctl.d/60-ip-forward.conf
  sudo iptables -A FORWARD -i eth1 -o docker0 -j ACCEPT
}

main "$@"
