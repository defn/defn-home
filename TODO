
jq -n \
  --arg instance_id "vagrant-$(date +%s)-$$" \
    '{"instance-id": $instance_id}' \
    | ruby -rjson -ryaml -e 'puts JSON.load(STDIN.read).to_yaml' > cidata/meta-data

jq -n \
  --arg ssh_key "$(cat ~/.ssh/vagrant.pub)" \
  --arg sudo "ALL=(ALL) NOPASSWD: ALL" \
    '{users: [ {name: "ubuntu", "ssh-authorized-keys": [ $ssh_key ], sudo: $sudo }]}' \
    | ruby -ryaml -rjson -e 'puts JSON.load(STDIN.read).to_yaml' | sed 's/^---/#cloud-config/' > cidata/user-data

mkisofs -R -V cidata -o cidata.iso cidata

  636  hdiutil create -o Desktop/InstallESD.cdr -size 8000m -layout SPUD -fs HFS+J
  638  hdiutil attach ~/Desktop/InstallESD.cdr.dmg -noverify -nobrowse -mountpoint /Volumes/iso
  641  hdiutil attach "/Applications/Install OS X El Capitan.app/Contents/SharedSupport/InstallESD.dmg" -mountpoint /Volumes/esd
  642  asr restore -source /Volumes/esd/BaseSystem.dmg -target /Volumes/iso -noprompt -noverify -erase
  645  cd OS\ X\ Base\ System/
  648  rm  System/Installation/Packages
  649  cp -rp /Volumes/esd/Packages System/Installation/
  650  cp -rp /Volumes/esd/BaseSystem.* System/
  656  diskutil eject /Volumes/OS\ X\ Base\ System
  657  hdiutil convert ~/Desktop/InstallESD.cdr.dmg -format UDTO -o ~/Desktop/InstallESD.iso
